name: Build Moonlight GDExtension (CMake + SCons)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        target:
          [
            { platform: linux, arch: x86_64, os: ubuntu-22.04 },
            # { platform: linux, arch: x86_32, os: ubuntu-22.04 },
            { platform: linux, arch: arm64, os: ubuntu-22.04-arm },
            # { platform: linux, arch: arm32, os: ubuntu-22.04-arm },
            { platform: windows, arch: x86_64, os: windows-latest },
            # { platform: windows, arch: x86_32, os: windows-latest },
            { platform: windows, arch: arm64, os: windows-latest },
            { platform: macos, arch: universal, os: macos-latest },
            { platform: android, arch: x86_64, os: ubuntu-22.04 },
            # { platform: android, arch: x86_32, os: ubuntu-22.04 },
            { platform: android, arch: arm64, os: ubuntu-22.04 },
            # { platform: android, arch: arm32, os: ubuntu-22.04 },
            { platform: ios, arch: arm64, os: macos-latest },
            { platform: web, arch: wasm32, os: ubuntu-22.04 },
          ]
        use_mbedtls: [false]
        target-type: [template_debug, template_release]
        float-precision: [single]


    runs-on: ${{ matrix.target.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # --- Install deps ---
      - name: Install MbedTLS (Linux/macOS)
        if: ${{ matrix.use_mbedtls == true && matrix.target.platform != 'windows' }}
        run: |
          if [[ "${{ matrix.target.platform }}" == "linux" ]]; then
            sudo apt-get update && sudo apt-get install -y libmbedtls-dev
          elif [[ "${{ matrix.target.platform }}" == "macos" ]]; then
            brew install mbedtls
          fi
      # Add linux x86_32 toolchain
      - name: Install multilib support
        if: ${{ matrix.target.platform == 'linux' && matrix.target.arch == 'x86_32' }}
        run: |
          sudo apt-get update && sudo apt-get install -y gcc-multilib g++-multilib

      - name: Install OpenSSL for Windows
        if: ${{ matrix.target.platform == 'windows' && matrix.use_mbedtls == false }}
        shell: pwsh
        run: |
          $url = "https://slproweb.com/download/Win64OpenSSL-1_1_1w.exe"
          Invoke-WebRequest -Uri $url -OutFile openssl.exe
          Start-Process -FilePath .\openssl.exe -ArgumentList "/silent","/verysilent" -Wait
          echo "OPENSSL_ROOT_DIR=C:\Program Files\OpenSSL-Win64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

      # --- Setup godot-cpp (prebuilt lib) ---
      - name: Setup godot-cpp
        uses: ./src/lib/godot-cpp/.github/actions/setup-godot-cpp
        with:
          platform: ${{ matrix.target.platform }}
          em-version: 3.1.62

      # --- Build with SCons (which calls CMake internally) ---
      - name: Build GDExtension
        if: ${{ matrix.target.platform != 'windows'}}
        shell: sh
        run: |
          scons \
            target=${{ matrix.target-type }} \
            platform=${{ matrix.target.platform }} \
            arch=${{ matrix.target.arch }} \
            precision=${{ matrix.float-precision }} \
            use_mbedtls=${{ matrix.use_mbedtls }}

      # --- Build with SCons (which calls CMake internally) ---
      - name: Build GDExtension (Windows)
        shell: sh
        if: ${{ matrix.target.platform == 'windows' && matrix.use_mbedtls == false }}
        run: |
          export OPENSSL_ROOT_DIR="C:\Program Files\OpenSSL-Win64"
          scons \
            target=${{ matrix.target-type }} \
            platform=${{ matrix.target.platform }} \
            arch=${{ matrix.target.arch }} \
            precision=${{ matrix.float-precision }} \
            use_mbedtls=${{ matrix.use_mbedtls }}

      # --- Upload artifact ---
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: moonlight-gdext-${{ matrix.target.platform }}-${{ matrix.target.arch }}-${{ matrix.target-type }}-${{ matrix.use_mbedtls }}
          path: bin/

  merge:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - name: Merge Artifacts
        uses: actions/upload-artifact/merge@v4
        with:
          name: moonlight-gdextension-all
          pattern: moonlight-gdext-*
          delete-merged: true