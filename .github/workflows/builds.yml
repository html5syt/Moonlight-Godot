name: Build Moonlight GDExtension

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - platform: linux
            arch: x86_64
            os: ubuntu-22.04
            use_mbedtls: false
          - platform: linux
            arch: x86_64
            os: ubuntu-22.04
            use_mbedtls: true
          - platform: linux
            arch: arm64
            os: ubuntu-22.04-arm
            use_mbedtls: false

          # Windows
          - platform: windows
            arch: x86_64
            os: windows-latest
            use_mbedtls: false
          - platform: windows
            arch: x86_64
            os: windows-latest
            use_mbedtls: true

          # macOS
          - platform: macos
            arch: universal
            os: macos-latest
            use_mbedtls: false
          - platform: macos
            arch: universal
            os: macos-latest
            use_mbedtls: true

          # Android (optional)
          - platform: android
            arch: arm64
            os: ubuntu-22.04
            use_mbedtls: false

          # # iOS (optional)
          # - platform: ios
          #   arch: arm64
          #   os: macos-latest
          #   use_mbedtls: false

        target-type: [template_debug, template_release]
        float-precision: [single]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # --- Install dependencies ---
      - name: Install multilib (Linux x86_32)
        if: ${{ matrix.platform == 'linux' && matrix.arch == 'x86_32' }}
        run: |
          sudo apt-get update && sudo apt-get install -y gcc-multilib g++-multilib

      - name: Install MbedTLS (if needed)
        if: ${{ matrix.use_mbedtls == true && matrix.platform != 'windows' }}
        run: |
          if [[ "${{ matrix.platform }}" == "linux" ]]; then
            sudo apt-get update && sudo apt-get install -y libmbedtls-dev
          elif [[ "${{ matrix.platform }}" == "macos" ]]; then
            brew install mbedtls
          fi

      - name: Download OpenSSL for Windows (non-MbedTLS)
        if: ${{ matrix.platform == 'windows' && matrix.use_mbedtls == false }}
        shell: pwsh
        run: |
          $url = "https://slproweb.com/download/Win64OpenSSL-1_1_1w.exe"
          $output = "openssl-installer.exe"
          Invoke-WebRequest -Uri $url -OutFile $output
          Start-Process -FilePath $output -ArgumentList "/silent", "/verysilent", "/sp-", "/suppressmsgboxes" -Wait
          echo "OPENSSL_ROOT=C:\Program Files\OpenSSL-Win64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

      # --- Setup godot-cpp ---
      - name: Setup godot-cpp
        uses: ./src/lib/godot-cpp/.github/actions/setup-godot-cpp
        with:
          platform: ${{ matrix.platform }}
          em-version: 3.1.62

      # --- Cache SCons ---
      - name: Restore .scons_cache
        uses: ./src/lib/godot-cpp/.github/actions/godot-cache-restore
        with:
          scons-cache: ${{ github.workspace }}/.scons-cache/
          cache-name: ${{ matrix.platform }}_${{ matrix.arch }}_${{ matrix.float-precision }}_${{ matrix.target-type }}_${{ matrix.use_mbedtls }}

      # --- Build ---
      - name: Build GDExtension
        shell: sh
        env:
          SCONS_CACHE: ${{ github.workspace }}/.scons-cache/
          OPENSSL: ${{ (matrix.platform == 'windows' && matrix.use_mbedtls == false) && 'C:\\Program Files\\OpenSSL-Win64' || '' }}
        run: |
          scons \
            target=${{ matrix.target-type }} \
            platform=${{ matrix.platform }} \
            arch=${{ matrix.arch }} \
            precision=${{ matrix.float-precision }} \
            use_mbedtls=${{ matrix.use_mbedtls }}

      # --- Save cache ---
      - name: Save .scons_cache
        uses: ./src/lib/godot-cpp/.github/actions/godot-cache-save
        with:
          scons-cache: ${{ github.workspace }}/.scons-cache/
          cache-name: ${{ matrix.platform }}_${{ matrix.arch }}_${{ matrix.float-precision }}_${{ matrix.target-type }}_${{ matrix.use_mbedtls }}

      # --- Cleanup Windows artifacts ---
      - name: Windows - Delete extra files
        if: ${{ matrix.platform == 'windows' }}
        shell: pwsh
        run: |
          Remove-Item bin/* -Include *.exp,*.lib,*.pdb -Force -ErrorAction SilentlyContinue

      # --- Upload artifact ---
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: moonlight-godot-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.target-type }}-${{ matrix.use_mbedtls }}
          path: ${{ github.workspace }}/bin/**

  merge:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - name: Merge Artifacts
        uses: actions/upload-artifact/merge@v4
        with:
          name: moonlight-godot-all
          pattern: moonlight-godot-*
          delete-merged: true